<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multi Image to WebP Converter (50KB)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

  <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-lg text-center">
    <h1 class="text-2xl font-bold mb-4">Convert Images to WebP (Max 50KB)</h1>
    
    <input type="file" id="imageInput" accept="image/*" multiple class="mb-4 block w-full border p-2 rounded">
    
    <button id="convertBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
      Convert Images
    </button>

    <div id="preview" class="grid grid-cols-2 gap-4 mt-4"></div>

    <button id="downloadAllBtn" class="hidden mt-4 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
      Download All as ZIP
    </button>
    
    <p id="status" class="mt-4 text-gray-600 text-sm"></p>
  </div>

  <script>
    const imageInput = document.getElementById("imageInput");
    const convertBtn = document.getElementById("convertBtn");
    const downloadAllBtn = document.getElementById("downloadAllBtn");
    const preview = document.getElementById("preview");
    const status = document.getElementById("status");

    let convertedImages = [];

    convertBtn.addEventListener("click", async () => {
      if (!imageInput.files.length) {
        alert("Please select one or more images first.");
        return;
      }

      status.textContent = "Processing images...";
      convertedImages = [];
      preview.innerHTML = "";

      for (let file of imageInput.files) {
        await processImage(file);
      }

      status.textContent = `Converted ${convertedImages.length} images successfully!`;
      if (convertedImages.length > 0) {
        downloadAllBtn.classList.remove("hidden");
      }
    });

    async function processImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            let width = img.width;
            let height = img.height;
            let quality = 0.9;
            let webpData;

            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            function compress() {
              canvas.width = width;
              canvas.height = height;
              ctx.clearRect(0, 0, width, height);
              ctx.drawImage(img, 0, 0, width, height);
              
              quality = 0.9;
              do {
                webpData = canvas.toDataURL("image/webp", quality);
                quality -= 0.05;
              } while (webpData.length / 1024 > 50 && quality > 0.1);

              if (webpData.length / 1024 > 50 && (width > 50 || height > 50)) {
                width = Math.round(width * 0.9);
                height = Math.round(height * 0.9);
                compress(); // resize and try again
              }
            }

            compress();

            if (webpData.length / 1024 <= 50) {
              convertedImages.push({
                name: file.name.replace(/\.[^/.]+$/, "") + ".webp",
                data: webpData
              });

              const imgEl = document.createElement("img");
              imgEl.src = webpData;
              imgEl.className = "w-full h-32 object-cover rounded";
              preview.appendChild(imgEl);
            }
            resolve();
          };
        };
        reader.readAsDataURL(file);
      });
    }

    downloadAllBtn.addEventListener("click", () => {
      const zip = new JSZip();
      convertedImages.forEach(img => {
        const base64Data = img.data.split(",")[1];
        zip.file(img.name, base64Data, { base64: true });
      });
      zip.generateAsync({ type: "blob" }).then((content) => {
        saveAs(content, "converted_images.zip");
      });
    });
  </script>

</body>
</html>
